name: Deploy to cPanel via FTPS (lftp)

on:
  push:
    branches: ["master"]

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: DNS check
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
        run: |
          echo "len=$(printf '%s' "$FTP_SERVER" | wc -c)"
          echo -n "hex="; printf '%s' "$FTP_SERVER" | od -An -t x1; echo
          getent hosts "$FTP_SERVER" || true

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Debug server resolution (safe)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "FTP_SERVER=$FTP_SERVER"
          echo -n "server-bytes="; printf '%s' "$FTP_SERVER" | od -An -t x1; echo
          echo -n "user-bytes="; printf '%s' "$FTP_USERNAME" | od -An -t x1; echo
          echo "password-length=$(printf '%s' "$FTP_PASSWORD" | wc -c)"
          getent hosts "$FTP_SERVER" || true

      - name: FTPS login test (no upload)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -e "
            set ssl:verify-certificate no;
            set ftp:ssl-force yes;
            set ftp:ssl-protect-data yes;
            set ftp:passive-mode yes;
            set ftp:ignore-pasv-address yes;

            open -p 21 $FTP_SERVER;
            user \"$FTP_USERNAME\" \"$FTP_PASSWORD\";
            ls;
            bye
          "

      - name: Deploy (mirror)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -e "
            set ssl:verify-certificate no;
            set ftp:ssl-force yes;
            set ftp:ssl-protect-data yes;
            set ftp:passive-mode yes;
            set ftp:ignore-pasv-address yes;

            open -p 21 \"$ftp.cloud208.cloudwebhosting.com\";
            user \"$FTP_USERNAME\" \"$FTP_PASSWORD\";

            mirror -R --delete --verbose \
              --exclude-glob .git* \
              --exclude-glob .github/ \
              --exclude-glob .vscode/ \
              --exclude-glob README.md \
              --exclude-glob .cpanel.yml \
              ./ /;

            bye
          "